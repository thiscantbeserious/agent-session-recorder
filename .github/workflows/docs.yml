name: Update Docs

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/cli.rs'
      - 'src/main.rs'
      - 'xtask/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  update-docs:
    name: Regenerate Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOCS_DEPLOY_KEY }}

      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate documentation (man pages + markdown)
        run: cargo xtask gen-docs --man --markdown

      - name: Check for doc changes
        id: doc-changes
        run: |
          if git diff --quiet docs/man docs/COMMANDS.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push docs
        if: steps.doc-changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git remote set-url origin git@github.com:${{ github.repository }}.git
          git add docs/man docs/COMMANDS.md
          git commit -m "docs: auto-regenerate documentation [skip ci]"
          git push

      - name: Generate wiki pages
        run: cargo xtask gen-docs --wiki

      - name: Check for wiki changes
        id: wiki-changes
        run: |
          # Check for both modified and untracked files
          if [ -z "$(git status --porcelain docs/wiki/)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR for wiki changes
        if: steps.wiki-changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs(wiki): update wiki pages"
          title: "docs(wiki): update wiki pages"
          body: |
            Auto-generated wiki page updates.

            Review the changes and merge to sync to the wiki.

            ðŸ¤– Generated by docs workflow
          branch: docs/wiki-update
          delete-branch: true
          add-paths: docs/wiki/
