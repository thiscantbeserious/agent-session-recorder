name: Sync Wiki

on:
  push:
    branches: [main]
    paths:
      - 'docs/wiki/**'

jobs:
  sync-wiki:
    name: Sync to GitHub Wiki
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOCS_DEPLOY_KEY }}

      - name: Checkout main repo
        uses: actions/checkout@v5
        with:
          path: main
          fetch-depth: 2  # Need history to detect what changed

      - name: Checkout wiki
        run: |
          git clone git@github.com:${{ github.repository }}.wiki.git wiki || {
            echo "Wiki doesn't exist yet, creating..."
            mkdir wiki
            cd wiki
            git init
            git remote add origin git@github.com:${{ github.repository }}.wiki.git
          }

      - name: Merge wiki changes (preserve human edits)
        run: |
          cd wiki
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Get list of changed files in docs/wiki/ from the push
          cd ../main
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- docs/wiki/ | sed 's|docs/wiki/||')
          cd ../wiki

          if [ -z "$CHANGED_FILES" ]; then
            echo "No wiki files changed in this push"
            exit 0
          fi

          echo "Files to sync: $CHANGED_FILES"

          # For each changed file, attempt a 3-way merge
          for file in $CHANGED_FILES; do
            src="../main/docs/wiki/$file"

            if [ ! -f "$src" ]; then
              # File was deleted in main repo
              if [ -f "$file" ]; then
                echo "Removing deleted file: $file"
                git rm "$file" 2>/dev/null || rm -f "$file"
              fi
              continue
            fi

            if [ ! -f "$file" ]; then
              # New file - just copy
              echo "Adding new file: $file"
              cp "$src" "$file"
            else
              # File exists in both - check if wiki version differs from what we'd generate
              if cmp -s "$src" "$file"; then
                echo "No changes needed: $file"
              else
                # Try to merge: use ours (wiki) as base, theirs (generated) as new
                # This preserves human edits while adding new generated content
                echo "Merging changes: $file"

                # Create backup of wiki version
                cp "$file" "$file.wiki"

                # Copy new generated version
                cp "$src" "$file.generated"

                # Attempt merge (wiki version takes precedence on conflicts)
                if git merge-file -p "$file.wiki" "$file.wiki" "$file.generated" > "$file.merged" 2>/dev/null; then
                  mv "$file.merged" "$file"
                  echo "  Merged successfully"
                else
                  # Conflict - keep wiki version (human edits), log warning
                  echo "  Conflict detected - keeping wiki version (human edits preserved)"
                  mv "$file.wiki" "$file"
                fi

                rm -f "$file.wiki" "$file.generated" "$file.merged"
              fi
            fi
          done

          # Check for changes
          git add -A
          if git diff --cached --quiet; then
            echo "No wiki changes to sync"
            exit 0
          fi

          git commit -m "docs: sync wiki from main repo (preserving human edits)"
          git push origin HEAD:master || git push origin HEAD:main
