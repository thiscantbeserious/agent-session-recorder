name: CI

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'build.rs'
      - 'install.sh'
      - '.github/**'
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  ASCIINEMA_VERSION: "3.1.0"
  CARGO_INSTA_VERSION: "1.46.1"

jobs:
  # 1. Build - ensure it compiles and share artifacts
  build:
    name: Build (${{ matrix.os == 'ubuntu-latest' && 'Linux' || 'macOS' }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v5

      - name: Cache compiled binary
        id: cache-binary
        uses: actions/cache@v5
        with:
          path: target/release/agr
          key: ${{ runner.os }}-agr-${{ hashFiles('src/**', 'Cargo.toml', 'Cargo.lock') }}

      - name: Install Rust
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: cargo build --release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agr-${{ runner.os }}
          path: target/release/agr
          retention-days: 1

  # 2. Unit Tests - verify logic (uses cached build)
  unit-tests:
    name: Unit Tests (${{ matrix.os == 'ubuntu-latest' && 'Linux' || 'macOS' }})
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        run: cargo test --verbose

  # 2b. Final checks - run on push to main or PRs with 'ready-to-merge' label
  # These are slower checks that catch memory safety issues
  # Jobs always run (so required status checks report), but steps are gated
  # on both the label AND actual source changes to avoid wasting CI time.

  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      src: ${{ steps.filter.outputs.src }}
    steps:
      - uses: actions/checkout@v5

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'Cargo.toml'
              - 'Cargo.lock'

  miri:
    name: "Final Check: Undefined Behavior (Miri)"
    needs: [build, detect-changes]
    runs-on: ubuntu-latest
    steps:
      - name: Check if final checks needed
        id: gate
        run: |
          echo "should_run=${{ (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ready-to-merge')) && needs.detect-changes.outputs.src == 'true' }}" >> $GITHUB_OUTPUT

      - name: Skip
        if: steps.gate.outputs.should_run != 'true'
        run: echo "Skipping — no source changes or no 'ready-to-merge' label"

      - uses: actions/checkout@v5
        if: steps.gate.outputs.should_run == 'true'

      - name: Install Rust nightly with Miri
        if: steps.gate.outputs.should_run == 'true'
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Get rustc version for cache key
        if: steps.gate.outputs.should_run == 'true'
        id: rustc
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo registry and Miri sysroot
        if: steps.gate.outputs.should_run == 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.cache/miri/
          key: miri-${{ steps.rustc.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            miri-${{ steps.rustc.outputs.version }}-
            miri-

      - name: Setup Miri
        if: steps.gate.outputs.should_run == 'true'
        run: cargo miri setup

      - name: Run Miri tests
        if: steps.gate.outputs.should_run == 'true'
        env:
          MIRIFLAGS: "-Zmiri-disable-isolation"
        run: |
          # Only run lib tests - integration tests spawn processes which Miri doesn't support
          # Skip modules that are Miri-incompatible:
          #   transform_ops  - FFI (fclonefileat, chmod) and tempfile I/O
          #   analyzer        - uses Rayon thread pools, tempfile, std::fs, process spawning
          #                     (memory safety covered by ASan/LSan job instead)
          #   storage        - tempfile::TempDir, fs::File::create, std::process::Command("df")
          #   commands::copy/completions/tests - tempfile::TempDir filesystem I/O
          #   config::migrate - insta snapshots call `cargo metadata` (process spawning)
          cargo miri test --lib -- \
            --skip transform_ops \
            --skip analyzer \
            --skip storage \
            --skip commands::copy \
            --skip commands::completions \
            --skip commands::tests \
            --skip config::migrate

  asan:
    name: "Final Check: Memory Leaks (ASan/LSan)"
    needs: [build, detect-changes]
    runs-on: ubuntu-latest
    steps:
      - name: Check if final checks needed
        id: gate
        run: |
          echo "should_run=${{ (github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'ready-to-merge')) && needs.detect-changes.outputs.src == 'true' }}" >> $GITHUB_OUTPUT

      - name: Skip
        if: steps.gate.outputs.should_run != 'true'
        run: echo "Skipping — no source changes or no 'ready-to-merge' label"

      - uses: actions/checkout@v5
        if: steps.gate.outputs.should_run == 'true'

      - name: Install Rust nightly with ASan support
        if: steps.gate.outputs.should_run == 'true'
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: x86_64-unknown-linux-gnu
          components: rust-src

      - name: Get rustc version for cache key
        if: steps.gate.outputs.should_run == 'true'
        id: rustc
        run: echo "version=$(rustc --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: Cache cargo registry
        if: steps.gate.outputs.should_run == 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: asan-${{ steps.rustc.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            asan-${{ steps.rustc.outputs.version }}-
            asan-

      - name: Run tests with AddressSanitizer
        if: steps.gate.outputs.should_run == 'true'
        env:
          # Use target-specific RUSTFLAGS to avoid applying to build scripts
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: "-Z sanitizer=address"
        run: |
          # Build std with sanitizer support via -Zbuild-std
          # Only run lib tests - integration tests spawn processes
          # Skip transform_ops tests - they use filesystem operations
          cargo +nightly test --lib -Zbuild-std --target x86_64-unknown-linux-gnu -- --skip transform_ops

  # 3. Coverage - generate test coverage and upload to Codecov
  coverage:
    name: Coverage
    needs: build
    runs-on: ubuntu-latest
    env:
      TARPAULIN_VERSION: 0.32.7
    steps:
      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        id: cache-registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache build artifacts
        id: cache-target
        uses: actions/cache@v5
        with:
          path: target/
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-

      - name: Cache cargo-tarpaulin
        id: cache-tarpaulin
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/cargo-tarpaulin
          key: ${{ runner.os }}-tarpaulin-${{ env.TARPAULIN_VERSION }}

      - name: Install cargo-tarpaulin
        if: steps.cache-tarpaulin.outputs.cache-hit != 'true'
        run: cargo install cargo-tarpaulin --version ${{ env.TARPAULIN_VERSION }}

      - name: Fetch dependencies
        if: steps.cache-registry.outputs.cache-hit != 'true'
        run: cargo fetch

      - name: Build dependencies
        if: steps.cache-target.outputs.cache-hit != 'true'
        run: cargo build --release

      - name: Generate coverage
        # Run lib and integration tests, skip performance tests (instrumentation overhead breaks timing)
        run: cargo tarpaulin --out xml --output-dir coverage --lib --test integration

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true
          version: v11.2.6
          skip_validation: true

  # 4. E2E Tests - verify integration (uses build artifacts, runs parallel with unit tests)
  e2e-tests:
    name: E2E Tests (${{ matrix.os == 'ubuntu-latest' && 'Linux' || 'macOS' }})
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: agr-${{ runner.os }}
          path: target/release/

      - name: Make binary executable
        run: chmod +x target/release/agr

      - name: Install asciinema (macOS)
        if: runner.os == 'macOS'
        run: brew install asciinema

      - name: Cache asciinema binary (Linux)
        if: runner.os == 'Linux'
        id: cache-asciinema
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/asciinema
          key: ${{ runner.os }}-asciinema-${{ env.ASCIINEMA_VERSION }}

      - name: Install Rust (for asciinema)
        if: runner.os == 'Linux' && steps.cache-asciinema.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Install asciinema v3 and clipboard tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xclip xsel xvfb
          if [ ! -f ~/.cargo/bin/asciinema ]; then
            cargo install asciinema --version ${{ env.ASCIINEMA_VERSION }}
          fi

      - name: Check asciinema version
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          asciinema --version

      - name: Run e2e tests (Linux)
        if: runner.os == 'Linux'
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          xvfb-run --auto-servernum ./tests/e2e_test.sh

      - name: Run e2e tests (macOS)
        if: runner.os == 'macOS'
        run: ./tests/e2e_test.sh

  # 5. Snapshot Tests - verify UI snapshots match committed versions
  snapshot-tests:
    name: Snapshot Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo-insta
        id: cache-insta
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/cargo-insta
          key: ${{ runner.os }}-cargo-insta-${{ env.CARGO_INSTA_VERSION }}

      - name: Install cargo-insta
        if: steps.cache-insta.outputs.cache-hit != 'true'
        run: cargo install cargo-insta --version ${{ env.CARGO_INSTA_VERSION }}

      - name: Run snapshot tests
        run: cargo insta test --check

  # Lint - runs in parallel, fast-fail for style issues
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings
